<p id="notice"><%= notice %></p>

<%= form_for(@pictograph, :html => {:class => 'form-horizontal', :multipart => true}) do |f| %>
  <% if @pictograph.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@pictograph.errors.count, "error") %> prohibited this pictograph from being saved:</h2>

      <ul>
      <% @pictograph.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <h3>
		<%= f.text_field :title, {:placeholder => 'Click to edit title', :class => 'hide edit', :id => "pictograph_title"} %><%=link_to 'ok', "#", {:id => "pictograph_title_submit", :class => 'btn hide submittable'}%><%=link_to @pictograph.title || 'Click to edit title', "#pictograph_title", {:class => "editable"} %>
  </h3>

	<table class='pictograph' style="border-spacing: <%=@pictograph.cell_spacing%>px;">
	  <tr class='top-row'><td>&nbsp;</td><td colspan='10' class='title'><%=@pictograph.title%></td></tr>
		<% row = Array.new %>
		<% all = Array.new %>
		<%# we always set the off color to 0 %>
		<% fill_index = 0 %>
		<% fill_risk = 0 %>
		<% current_fill_index = 0 %>
	  <% for i in 1..100 %>
	    <%
				val = fill_risk == 0 ? @pictograph.off_value : @pictograph.risks[fill_risk].value
				val.to_i if !val.is_a? Integer
			
				# increment if we've hit our mark
				if current_fill_index == val
					fill_index += 1
					fill_risk = @pictograph.risks.length - fill_index
					current_fill_index = 0
				end
				if @pictograph.risks[fill_risk].icon?
					fill_icon = @pictograph.risks[fill_risk].icon.url(:default) # NOTE: we may want to default to upload size
				else
					fill_color = @pictograph.risks[fill_risk].hex
					fill_icon = false
				end
				current_fill_index += 1
			%>

			<%
				if fill_icon
					# we should just default to whatever size they upload at--though this doesn't really work for print
					# maybe the resizing is just for previewing a print icon array?
					row << "<td id='cell#{100 - i + 1}' class='picto-cell fill#{fill_risk}' data-icon='#{fill_icon}'><img src=\'#{fill_icon}\' alt=\'risk #{fill_risk} icon\'></td>"
					# also, the fill class won't work with icons
				else
		    	row << "<td id='cell#{100 - i + 1}' style='background-color: #{fill_color}; width: #{@pictograph.cell_width}px; height: #{@pictograph.cell_height}px;' class='picto-cell fill#{fill_risk}' data-color='#{fill_color}'></td>"
				end
		    if i % 10 == 0
		      if @pictograph.axis_labels
		        axis_num = (100 - i) + 10
		        if @pictograph.axis_position == 'left'
		          row.push "<td class='picto-axis-label'><div style='font-size: #{@pictograph.axis_font_size}px; line-height: #{@pictograph.axis_line_height}px; margin-top: -#{@pictograph.axis_margin_top}px;'>#{axis_num} ---</div></td>"
		        else
		          row.shift "<td class='picto-axis-label'><div style='font-size: #{@pictograph.axis_font_size}px; line-height: #{@pictograph.axis_line_height}px; margin-top: -#{@pictograph.axis_margin_top}px;'> --- #{axis_num}</div></td>"
		        end
		      end
		      out = "<tr>#{row.reverse.join()}</tr>".html_safe
					row = Array.new
				else
					out = nil
		    end
			%>
			<%= out if out %>
		<% end %>
  
	  <tr class='bottom-row'>
			<% if @pictograph.axis_labels %>
				<% if @pictograph.axis_position == 'left' %>
		    	<td class='picto-axis-label'><div style='font-size: <%=@pictograph.axis_font_size%>px; line-height: <%=@pictograph.axis_line_height%>px; margin-top: -<%=@pictograph.bottom_axis_margin_top%>px;'>0 ---</div></td>
		    <% else %>
		      <td class='picto-axis-label'><div style='font-size: <%=@pictograph.axis_font_size%>px; line-height: <%=@pictograph.axis_line_height%>px; margin-top: -<%=@pictograph.bottom_axis_margin_top%>px;'> --- 0</div></td>
		    <% end %>
			<% end %>
			<td colspan='10' class='legend'>&nbsp;</td>
		</tr>
	</table>

	<%
	  # if legend[:risk_text]
	  #   legend_out = "<dl class=\"legend-wrapper\">"
	  #   %w[risk reduced_risk incremental_risk off].each do |l|
	  #     ltext = legend[(l + '_text').to_sym]
	  #     limage = legend[(l + '_image').to_sym]
	  #     if !ltext.blank?
	  #       if @options['legend_risk_image'] or @options['legend_use_picto_images']
	  #         full_limage = "/surveys/#{theme_name}/images/#{limage}"
	  #       else 
	  #         full_limage = "/images/#{limage}"
	  #       end
	  #       legend_out += "<dt class=\"legend-key\"><img src=\"#{full_limage}\" /></dt>"
	  #       legend_out += "<dd class=\"legend\">#{ltext}</dd>"
	  #     end
	  #   end
	  #   legend_out += "</dl>"
	  #   out += legend_out
	  # end
	  # 
	  # return out
	%>

	<div id="editor">
			<dl id="risk-legend">
				<% i = 0 %>	  
				<%= f.fields_for :risks do |r| %>
					<dt id="risky<%=i%>" style="width: <%=@pictograph.cell_width + 20%>px;">
						<div class="legend-icon" id="test<%=i%>" style="width: <%=@pictograph.cell_width%>px; height: <%=@pictograph.cell_height%>px; background-color: <%=@pictograph.risks[i].hex%>;" data-color="<%=@pictograph.risks[i].hex%>"></div>
				    <div class="risk-fill hide" id="risk-fill_<%=i%>"><%= r.text_field :hex, {:class => 'color-field'} %></div>
					</dt>
					<dd id="frisky<%=i%>" style="width: <%=400 - (@pictograph.cell_width + 20)%>px;">
						<% if i == 1 %>
							<%= r.number_field :value, {:class => 'span1 risk-field risk-val', :id => "risks_#{i}_value"} %><%=link_to 'ok', "#", {:id => "risks_#{i}_value_submit", :class => 'btn submittable edit'}%><%=link_to @pictograph.risks[i].value, "#risks_#{i}_value", {:class => " hide editable"} %>
						<% elsif i > 1 %>
							<%= r.number_field :value, {:class => 'span1 risk-field hide risk-val', :id => "risks_#{i}_value"} %><%=link_to 'ok', "#", {:id => "risks_#{i}_value_submit", :class => 'btn hide submittable edit'}%><%=link_to @pictograph.risks[i].value, "#risks_#{i}_value", {:class => "editable"} %>
						<% else%>
							<span id="#risks_<%=i%>_value" class="risk-val"><%= @pictograph.off_value %></span>
						<% end %>
						 <%= r.text_field :description, {:placeholder => "out of #{@pictograph.cells} population members exhibit this property", :class => 'span4 hide edit', :id => "risks_#{i}_description"} %><%=link_to 'ok', "#", {:id => "risks_#{i}_description_submit", :class => 'btn hide submittable'}%><%=link_to @pictograph.risks[i].description.blank? ? "out of #{@pictograph.cells} population members exhibit this property" : @pictograph.risks[i].description, "#risks_#{i}_description", {:class => "editable"} %>
					</dd>
					<% i += 1 %>
				<% end %>
			</dl>
			<%=link_to '+', new_risk_path(:tab => @pictograph.risks.length), {:remote => true}%>

			<!-- <ul class="nav nav-tabs">
				<% @pictograph.risks.each_with_index do |risk, i| %>
					<li class='<%="active" if i == 1 %>'><a href="#color<%=i%>" data-toggle="tab" style="background-color: <%=@pictograph.risks[i].hex%>;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a></li>
				<% end %>
				<li id="new-risk"><%=link_to '+', new_risk_path(:tab => @pictograph.risks.length), {:remote => true}%></li>
			</ul> -->

			<!-- <div class="tab-content">
				<% i = 0 %>	  
				<%= f.fields_for :risks do |r| %>
					<%= render '/risks/form', :r => r, :i => i %>
					<% i += 1 %>
				<% end %>
			</div> --><!-- End tab content -->

			<!--
			<div class="tab-pane" id="fine-tuning">
			  <div class="field">
			    <%= f.label :cell_width %>
			    <%= f.number_field :cell_width, {:class => 'span1'} %>
			  </div>
			  <div class="field">
			    <%= f.label :cell_height %>
			    <%= f.number_field :cell_height, {:class => 'span1'} %>
			  </div>
			  <div class="field">
			    <%= f.label :cell_spacing %>
			    <%= f.number_field :cell_spacing, {:class => 'span1'} %>
			  </div>
			  <div class="field">
			    <%= f.label :cols %>
			    <%= f.number_field :cols, {:class => 'span1'} %>
			  </div>
			  <div class="field">
			    <%= f.label :rows %>
			    <%= f.number_field :rows, {:class => 'span1'} %>
			  </div>
			  <div class="field checkbox">
			    <%= f.check_box :axis_labels %> <%= f.label :axis_labels %> 
			  </div>
			  <div class="field radio">
			    <%= f.label :axis_position_left, 'left' %><%= f.radio_button :axis_position, 'left' %><br />
					<%= f.label :axis_position_right, 'right' %><%= f.radio_button :axis_position, 'right' %>
			  </div>
			  <div class="field">
			    <%= f.label :axis_font %>
			    <%= f.text_field :axis_font %>
			  </div>
			  <div class="field">
			    <%= f.label :axis_font_size %>
			    <%= f.number_field :axis_font_size, {:class => 'span1'} %>px
			  </div>
			  <div class="field">
			    <%= f.label :axis_width %>
			    <%= f.number_field :axis_width, {:class => 'span1'} %>px
			  </div>
			</div>
			-->
	</div>

	<br clear="left" />
	
  <div class="actions">
    <!-- <%= f.submit "Save" %> <%= f.submit 'Preview' %> -->
		<%=link_to 'save/share', '#save-share', {:class => 'btn'} %> <%=link_to 'embed', '#', {:class => 'btn'} %> <%=link_to 'download image', '#', {:class => 'btn'} %>
  </div>

	<div class="modal" id="save-share">
	  <div class="modal-header">
	    <a class="close" data-dismiss="modal">Ã—</a>
	    <h3>Save/Share</h3>
	  </div>
	  <div class="modal-body">
	    <p>Here is the URL <%=request.url%></p>
	  </div>
	  <div class="modal-footer">
	    <a href="#" data-dismiss="modal" class="btn">Close</a>
	  </div>
	</div>

<% end %>