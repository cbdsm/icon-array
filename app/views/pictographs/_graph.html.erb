<table class='pictograph' style="border-spacing: <%=@pictograph.cell_spacing%>px; width: <%=@pictograph.table_width%>px;">
	<% row = Array.new %>
	<% all = Array.new %>
	<%# we always set the off color to 0 %>
	<% fill_index = 0 %>
	<% fill_risk = 0 %>
	<% current_fill_index = 0 %>
	<% is_dec = false %>
  <% for i in 1..@pictograph.cells %>
    <%
			val = fill_risk == 0 ? @pictograph.off_value : @pictograph.risks[fill_risk].value
			if !val.is_a? Integer
			  val = val.floor.to_i
			end
			
			# decimal handling
			if @pictograph.risks[fill_risk + 1]
				dval = @pictograph.risks[fill_risk + 1].value
				d = dval - dval.floor
				if d > 0.0 
					is_dec = true
				else
					d = 1.0
				end
			else
				d = 1.0
			end
			
			# if we use decimals, we're rounding, and we lose a cell
			val += 1 if is_dec and fill_risk > 0
		
			# increment if we've hit our mark
			if current_fill_index == val
				fill_index += 1
				fill_risk = @pictograph.risks.length - fill_index
				current_fill_index = 0
				dec = d
			else
				dec = 1.0
			end
			if !@pictograph.icon.blank?
				fill_icon = @pictograph.risks[fill_risk].icon.url(:default) # NOTE: we may want to default to upload size
			else
				fill_icon = false
			end
			fill_color = @pictograph.risks[fill_risk].hex
			fill_color = '#' + fill_color if fill_color[0] != '#'
			current_fill_index += 1
		%>

		<%
			if fill_icon
				# we should just default to whatever size they upload at--though this doesn't really work for print
				# maybe the resizing is just for previewing a print icon array?
				td = "<td id='cell#{@pictograph.cells - i + 1}' class='picto-cell fill#{fill_risk}' data-icon='#{fill_icon}' data-color='#{fill_color}'>"
				td += icon(@pictograph.icon, fill_color, @pictograph.cell_height, @pictograph.cell_width)
				td += "</td>"
				row << td.html_safe
				# also, the fill class won't work with icons
			else
	    	row << "<td id='cell#{@pictograph.cells - i + 1}' style='background-color: #{@pictograph.risks[0].hex};padding:0; width: #{@pictograph.cell_width}px; height: #{@pictograph.cell_height}px;' class='picto-cell fill#{fill_risk}' data-color='#{fill_color}'><div style='background-color: #{fill_color}; width: #{@pictograph.cell_width }px; height: #{@pictograph.cell_height * dec}px; margin-top: #{@pictograph.cell_height * (1.0 - dec)}px;'></div></td>"
			end
	    if i % @pictograph.cols == 0
	      if @pictograph.axis_labels
	        axis_num = (@pictograph.cells - i) + @pictograph.cols
	        if @pictograph.axis_position == 'left'
	          row.push "<td class='picto-axis-label' style='text-align:right; width: #{@pictograph.axis_width}px;'><div style='font-size: #{@pictograph.axis_font_size}px; line-height: #{@pictograph.axis_line_height}px; margin-top: -#{@pictograph.axis_margin_top}px;'>#{axis_num} ---</div></td>"
	        else
	          row.shift "<td class='picto-axis-label' style='text-align:left; width: #{@pictograph.axis_width}px;'><div style='font-size: #{@pictograph.axis_font_size}px; line-height: #{@pictograph.axis_line_height}px; margin-top: -#{@pictograph.axis_margin_top}px;'> --- #{axis_num}</div></td>"
	        end
	      end
	      out = "<tr>#{row.reverse.join()}</tr>".html_safe
				row = Array.new
			else
				out = nil
	    end
		%>
		<%= out if out %>
	<% end %>

  <tr class='bottom-row'>
		<% if @pictograph.axis_labels %>
			<% if @pictograph.axis_position == 'left' %>
	    	<td class='picto-axis-label' style="text-align:right; width: <%=@pictograph.axis_width%>px;"><div style='font-size: <%=@pictograph.axis_font_size%>px; line-height: <%=@pictograph.axis_line_height%>px; margin-top: -<%=@pictograph.bottom_axis_margin_top%>px;'>0 ---</div></td>
	    <% else %>
	      <td class='picto-axis-label' style="text-align:left; width: <%=@pictograph.axis_width%>px;"><div style='font-size: <%=@pictograph.axis_font_size%>px; line-height: <%=@pictograph.axis_line_height%>px; margin-top: -<%=@pictograph.bottom_axis_margin_top%>px;'> --- 0</div></td>
	    <% end %>
		<% end %>
		<td colspan='<%=@pictograph.cols%>' class='legend'>&nbsp;</td>
	</tr>
</table>